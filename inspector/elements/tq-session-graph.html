<!-- Copyright 2016 The Fuchsia Authors. All rights reserved. -->

<dom-module id="tq-session-graph">
    <template>
      <style>
      .node circle {
        fill: #fff;
        stroke: steelblue;
        stroke-width: 1.5px;
      }

      .node {
        font: 10px sans-serif;
      }

      .link {
        fill: none;
        stroke: #ccc;
        stroke-width: 2.5px;
      }

      </style>
      <tq-graph-utils id="utils" width="[[width]]" height="[[height]]"></tq-graph-utils>
      <svg id="svg" xmlns="http://www.w3.org/2000/svg" version="1.1"
          width="[[width]]" height="[[height]]"
          pointer-events="all">
        <g id="container">
        </g>
      </svg>
    </template>
    <script>
    (function() {
      'use strict';

      // Take dicts of nodes and edges and make a tree for a d3 tree layout.
      // Something like: http://bl.ocks.org/mbostock/raw/4063550/flare.json
      function makeTree(_nodes, _edges, rootNodeId) {
          let nodes = JSON.parse(JSON.stringify(_nodes));
          let edges = JSON.parse(JSON.stringify(_edges));
          // Give all the nodes a children array.
          Object.getOwnPropertyNames(nodes)
              .forEach((nid) => { nodes[nid].children = []; });
          // Use edges to determine children relationships.
          Object.getOwnPropertyNames(edges).forEach((eid) => {
              let edge = edges[eid];
              nodes[edge.origin].children.push(nodes[edge.target]);
              // Targets are named by their edges
              nodes[edge.target].labels = edge.labels;
          });
          return nodes[rootNodeId];
      }

      let diagonal = d3.svg.diagonal().projection(function(d) { return [d.y, d.x]; });

      function abbreviateLabels(labels) {
          return labels.map((l) => l.replace(/.*[:/]/,'')).join(' ');
      }

      function decodeDataURI(uri) {
          return atob(uri.substr(13))
      }

      Polymer({
        is: 'tq-session-graph',
        properties: {
            json: {
                type: Object,
                observer: '_jsonChanged',
            },
            width: {
                type: Number,
                value: 800,
            },
            height: {
                type: Number,
                value: 600,
            },
            node: {
                type: Object,
                notify: true,
            }
        },
        ready: function() {
          this.$.utils.root = this.$.svg;
          this.$.utils.container = this.$.container;
        },
        _jsonChanged: function() {
            let json = this.json;
            let container = d3.select(this.$.container);

            let tree = makeTree(json.graph.nodes, json.graph.edges, json.rootNode.id);
            this.treeLayout = d3.layout.tree()
                .nodeSize([20, 200]);

            container.selectAll('*').remove();

            let nodes = this.treeLayout.nodes(tree);
            let links = this.treeLayout.links(nodes);

            // Make this available in callbacks...
            let element = this;

            var link = container.selectAll("path.link").data(links);
            link.enter().append("path")
                .attr("class", "link")
                .attr("d", diagonal);

            var node = container.selectAll("g.node")
                .data(nodes);
            var nodeGroup = node.enter().append("g")
                .attr("class", "node")
                .attr('id', (d) => d.id)
                .attr("transform", (d) => `translate(${d.y}, ${d.x})`)

            nodeGroup.append("circle")
                .attr("r", 4.5);

            nodeGroup.append("text")
                .attr("dx", (d) => d.children ? -8 : 8)
                .attr("dy", 3)
                .attr("text-anchor", (d) => d.children ? "end" : "start")
                .text((d) => d.labels?abbreviateLabels(d.labels):'root');
            nodeGroup.on('click', function(d) {
                element.node = d;
            });
            this.scopeSubtree(this.$.container, true);
        }
      });
    })();
    </script>
</dom-module>
